name: Analyze Changelog

on:
  push:
    branches: [ "main" ]
    paths:
      - 'CHANGELOG.md'
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Read Changelog
        id: read_changelog
        run: |
          # Read the first 200 lines of CHANGELOG.md to avoid payload limits
          CONTENT=$(head -n 200 CHANGELOG.md)
          # Escape newlines for JSON
          CONTENT="${CONTENT//'%'/'%25'}"
          CONTENT="${CONTENT//$'\n'/'\\n'}"
          CONTENT="${CONTENT//$'\r'/'}'"
          echo "content=$CONTENT" >> $GITHUB_OUTPUT

      - name: Send to Dashboard
        run: |
          curl -X POST ${{ secrets.DASHBOARD_URL }}/api/ingest/changelog \
          -H "Content-Type: application/json" \
          -d '{
            "repoName": "${{ github.event.repository.name }}",
            "content": "${{ steps.read_changelog.outputs.content }}"
          }'
