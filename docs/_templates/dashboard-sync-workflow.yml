name: Sync to Dashboard

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Sync Payload
        id: payload
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          REPO_FULL_NAME: ${{ github.repository }}
          REPO_URL: ${{ github.event.repository.html_url }}
        run: |
          # Dieses Skript erstellt die payload.json sicher mit Node.js
          node -e '
            const fs = require("fs");
            const path = require("path");

            // 1. Suche nach API Specs (Priorisierte Liste)
            const specPaths = [
              "openapi.json",
              "public/openapi.json",
              "docs/openapi.json",
              "swagger.json",
              "dist/swagger.json"
            ];
            
            let apiSpec = null;
            let usedPath = null;
            
            for (const p of specPaths) {
              if (fs.existsSync(p)) {
                try {
                  // Versuch, es als JSON zu parsen, um Validit√§t zu pr√ºfen
                  const content = fs.readFileSync(p, "utf8");
                  JSON.parse(content); 
                  apiSpec = content;
                  usedPath = p;
                  break;
                } catch (e) {
                  console.error(`Invalid JSON in ${p}:`, e.message);
                }
              }
            }

            // 2. Lese package.json f√ºr Tech-Stack Info
            let pkg = { engines: {}, dependencies: {}, devDependencies: {} };
            if (fs.existsSync("package.json")) {
              try {
                pkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
              } catch (e) {}
            }

            // 3. Konstruiere das Payload-Objekt
            const payload = {
              repoName: process.env.REPO_NAME,
              nameWithOwner: process.env.REPO_FULL_NAME,
              repoUrl: process.env.REPO_URL,
              description: "Synced via GitHub Actions",
              isPrivate: true, // Annahme, kann angepasst werden
              apiSpec: apiSpec, // String-Inhalt oder null
              packageJson: {
                engines: pkg.engines,
                dependencies: pkg.dependencies,
                devDependencies: pkg.devDependencies
              },
              metadata: {
                syncedAt: new Date().toISOString(),
                specPath: usedPath
              }
            };

            // 4. Schreibe Payload in Datei (um Shell-Escaping Probleme zu vermeiden)
            fs.writeFileSync("payload.json", JSON.stringify(payload));
            
            if (usedPath) console.log(`‚úÖ Found API Spec at: ${usedPath}`);
            else console.log("‚ö†Ô∏è No API Spec found in standard locations.");
          '

      - name: Send to Dashboard
        env:
          DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}
          DASHBOARD_API_KEY: ${{ secrets.DASHBOARD_API_KEY }}
        run: |
          if [ -z "$DASHBOARD_URL" ]; then
            echo "‚ùå Error: DASHBOARD_URL secret is missing."
            exit 1
          fi

          echo "üöÄ Sending payload to $DASHBOARD_URL/api/system/ingest..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$DASHBOARD_URL/api/system/ingest" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $DASHBOARD_API_KEY" \
            -d @payload.json)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "‚úÖ Sync successful!"
            echo "$BODY"
          else
            echo "üí• Sync failed with status $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi
